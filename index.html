<html>
  <head>
    <title>s</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta charset="utf-8">
    <style>
      body {
        font-family: Arial, sans-serif;
      }
      .message {
        border-radius: 10px;
        padding: 5px;
        background-color: #f5f5f5;
        border: 2px solid #ccc;
        margin-top: 10px;
      }
      button {
        padding: 5px;
        background-color: white;
        border-radius: 5px;
        font-family: Arial, sans-serif;
      }
    </style>
    <script>
      function displayError(msg) {
        console.log("Error being displayed, "+ msg);
        var container = document.getElementById('messagesTop');

        var toAdd = document.createElement('div');

        var p = document.createElement("p");
        p.appendChild(document.createTextNode(msg));
        toAdd.appendChild(p);

        toAdd.className = "message";
        toAdd.style.backgroundColor = "pink";
        toAdd.style.border = "2px solid "+ "red";

        if (container) container.appendChild(toAdd);
        else {
          console.log("Document, hasn't loaded yet, adding listener ", toAdd);
          function add() {
            document.getElementById('messagesTop').appendChild(toAdd);
            console.log("Added, ", toAdd);
          }
          document.addEventListener("load", add);
          setTimeout(add, 500);
        }
      }

      window.onerror = function(e) {
          displayError("Någonting gick fel, "+ e);
      }
    </script>
    <script src="celebreateSummerHoliday.js"></script>
    <script>

      /* Generated from https://alvinn8.github.io/s/editor/ */
      var mdata = [{"lunch":3,"lessons":[{"start":480,"end":570,"subject":"Matematik","classroom":"G38","material":"Matteböcker"},{"start":585,"end":645,"subject":"NO","classroom":"N08","material":"Fysikboken"},{"start":655,"end":705,"subject":"Svenska","classroom":"G18"},{"start":745,"end":820,"subject":"SO","classroom":"G39","material":"So skrivbok"},{"start":830,"end":895,"subject":"Engelska","classroom":"G18","material":"Engelska Böcker"},{"start":900,"end":930,"subject":"Klassråd","classroom":"G18","note":"Vi kan börja den här lektionen direkt när engelskan slutar"}]},{"lunch":3,"lessons":[{"start":535,"end":605,"subject":"Spanska","classroom":"G15","material":"Spanska mapp"},{"start":610,"end":650,"subject":"Matematik","classroom":"G13","material":"Matteböcker","note":"Det kan vara i ett annat klassrum, på infomentor står det G13 men jag tror vi har varit i lite olika klassrum"},{"start":665,"end":720,"subject":"Idrott","classroom":"Hall A","material":"Idrottskläder"},{"start":770,"end":810,"subject":"SO","classroom":"G39","material":"So skrivbok"},{"start":820,"end":865,"subject":"Svenska","classroom":"G18"},{"start":875,"end":935,"subject":"NO-Lab","classroom":"N08","note":"Varannan vecka","material":"Fysikboken"}]},{"lunch":2,"lessons":[{"start":500,"end":580,"subject":"Bild","classroom":"Bildsalen"},{"start":595,"end":660,"subject":"Matematik","classroom":"G15","material":"Matteböcker"},{"start":705,"end":830,"subject":"Hemkunskap","classroom":"Hemkunskapsalen","material":"Hemkunskapsboken"},{"start":840,"end":895,"subject":"Studieverkstad","classroom":""}]},{"lunch":2,"lessons":[{"start":510,"end":580,"subject":"Teknik","classroom":"N08"},{"start":595,"end":660,"subject":"Svenska","classroom":"G31"},{"start":710,"end":785,"subject":"Spanska","classroom":"G15","material":"Spanska mapp"},{"start":790,"end":820,"subject":"Matematik","classroom":"T20","material":"Matteböcker"},{"start":830,"end":910,"subject":"Profil","classroom":""}]},{"lunch":2,"lessons":[{"start":510,"end":570,"subject":"Engelska","classroom":"G18","material":"Engelska Böker"},{"start":600,"end":655,"subject":"Idrott","classroom":"Hall A","material":"Idrottskläder"},{"start":705,"end":765,"subject":"NO","classroom":"N09","material":"Fysikboken"},{"start":775,"end":865,"subject":"SO","classroom":"G39","material":"So skrivbok"}]}];

      var overrides = {
        lessons: [
          {
            date: [6, 12],
            lesson: [2, 2],
            overrides: {
              start: 730,
              note: "Lektionen börjar vanligtvis 11:45 men just idag börjar den 12:10"
            }
          }
        ],
        days: [
          {
            date: [6,13],
            subject: "Samling i klassrummet (Skolavslutning)",
            start: 525,
            end: 540,
            classroom: "G18"
          },
          {
            date: [6,13],
            subject: "Sommaravslutning i aulan (Skolavslutning)",
            start: 540,
            end: 585,
            classroom: "Aulan"
          },
          {
            date: [6,13],
            subject: "Betgsutdelning och fika (Skolavslutning)",
            start: 585,
            end: 645,
            classroom: "G18",
            note: "Jag vet inte den exakta tiden vi slutar, skrev bara en timme"
          }
        ]
      };

      var updatedAt;
      var currentState;
      var allBoredLinks = ["https://theuselessweb.com/","http://run3online.com/","https://zh.y8.com/games/slope"];
      var boredLinks = allBoredLinks.slice(0); // clone allBoredLinks
      var shortcutMode = 0;
      var lunches = [];

      //var messages = {constant:[{message:"Schemat har ändrats men den här sidan har fortfarande det gamla. Ska lägga in det nya snart",backcolor:"pink",bordercolor:"red"}],date:[{date:[8,6],message:"Idag börjar profilerna"}]}

       // First index of date is month, second is date

      var messages = {constant:[],date:[/*{date:[6,13], message:"Skolavslutning, \"Sommaravslutning i aulan kl: 09:00-09:30/45. Alla klasser träffas i klassrummen kl 0845 och går gemensamt till aulan kl 0900, därefter betygsutdelning i klassrummen.\", från kalender i infomentor"},*/{date:[6,12],message:"Hemkunskapen börjar 12:10 istället för 11:45"}]}

      var state = {
          "SCHOOL_OVER" : 1,
          "WEEKEND"     : 2,
          "IN_LESSON"   : 3,
          "BREAK"       : 4

      };
      var debugMsg = {
        ikdLineUp: false
      }
      var dayNames = [
        "Måndag",
        "Tisdag",
        "Onsdag",
        "Torsdag",
        "Fredag"
      ]

      console.log("Starting calcSeconds interval");
      var calcSecondsIntervalId = setInterval(calcSeconds, 1000);

      //var fakeNowTime = 560;
      var fakeNowTime;
      function nowTime() {

        var date = new Date();
        if (!fakeNowTime) return date.getHours() * 60 + date.getMinutes();
        else return fakeNowTime;

      }

      var day = new Date().getDay()-1;
      var lunchDay = day;

      if ((lunchDay > 4) || (lunchDay < 0)) lunchDay = 4;

      //var day = 4;
      //var lunchDay = 4;

      Node.prototype.addSafeText = function(text) {

          var toAdd = document.createTextNode(text);
          this.appendChild(toAdd);

          return this;

      }

      Node.prototype.setSafeText = function(text) {

          this.innerHTML = "";
          this.addSafeText(text);

          return this;

      }

      Node.prototype.addSafeElement = function(tag, text) {

          var toAdd = document.createElement(tag);
          toAdd.addSafeText(text);
          this.appendChild(toAdd);

          return this;

      }
      
      window.onkeydown = function(e) {

        function initShortcut() {
          document.getElementById("shortcut").style.display = "block";
          document.getElementById("shortcutSmall1").innerHTML = "";
          document.getElementById("shortcutBig1").innerHTML = "";
          document.getElementById("shortcutSmall2").innerHTML = "";
          document.getElementById("shortcutBig2").innerHTML = "";

        }

        var path = typeof e.composedPath == "function" ? e.composedPath() : [];
        if ((!path.length || !path[0] || !path[0] instanceof Element) || (path.length && path[0] instanceof Element && path[0].tagName != "INPUT")) {
      
          if (e.key == "r") {
        
            newDay();
            calcMinutes();
          
          } else if (e.key == "a") {
            initShortcut();
            shortcutMode = 1;
            var big1 = document.getElementById("shortcutBig1");

            var toAdd = document.createElement("span");
            toAdd.id = "shortcutBig1Minutes";
            big1.appendChild(toAdd);

            var toAdd2 = document.createElement("span");
            toAdd2.id = "shortcutBig1Seconds";
            big1.appendChild(toAdd2);

            calcSeconds();
            calcMinutes();
          } else if (e.key == "b") {
            initShortcut();
            shortcutMode = 2;
            newDay();
            var length = mdata[day].lessons.length;

            document.getElementById("shortcutBig1").setSafeText(toClockTime(mdata[day].lessons[length - 1].end));
            document.getElementById("shortcutSmall1").setSafeText("Idag slutar vi klockan");
            if (day == 2) {
              document.getElementById("shortcutBig2").setSafeText(toClockTime(mdata[day].lessons[length - 2].end));
              document.getElementById("shortcutSmall2").setSafeText("Eller om du inte behöver gå på studieverkstad, slutar du klockan");
            } else if (day == 1) {
              document.getElementById("shortcutBig2").setSafeText(toClockTime(mdata[day].lessons[length - 2].end));
              document.getElementById("shortcutSmall2").setSafeText("Eller om du inte har NO-Lab, slutar du klockan");
            } else if (day == 0) {
              document.getElementById("shortcutSmall2").setSafeText("Fast vi brukar ofta sluta tidigare på klassrådet");
            }
          }
        }
        
      }

      // Load overrides

      try {

        for (var lessonOverride of overrides.lessons) {
          console.log("Loading override "+ lessonOverride.lesson.join(" "), lessonOverride);
          // TODO: add date checking
          //mdata[lessonOverride.lesson[0]].lessons[lessonOverride.lesson[1]]
          if (Object.keys(lessonOverride.overrides).length) {
            mdata[lessonOverride.lesson[0]].lessons[lessonOverride.lesson[1]].beforeOverrides = Object.assign({}, mdata[lessonOverride.lesson[0]].lessons[lessonOverride.lesson[1]]);
            mdata[lessonOverride.lesson[0]].lessons[lessonOverride.lesson[1]].wasOverridden = true;

          }
          for (var override in lessonOverride.overrides) {
            (function(val) {
              Object.defineProperty(mdata[lessonOverride.lesson[0]].lessons[lessonOverride.lesson[1]], override, {
                get: function() {
                  return val;
                }
              });
              console.log("Overridden lesson "+ lessonOverride.lesson.join(" ") + ", property "+ override +" with "+ val);
            })(lessonOverride.overrides[override]);
          }
        }

        for (var dayOverride of overrides.days) {
          var date = new Date();
          date.setDate(dayOverride.date[0]);
          date.setMonth(dayOverride.date[1]);
          var mdataWeekDay = date.getDay() - 1;
          dayOverride.day = mdataWeekDay;
          for (var lesson of mdata[mdataWeekDay].lessons) {
            lesson.isDisabled = true;
            lesson.hideNewOverride = true;
            lesson.wasOverridden = true;
            lesson.beforeOverrides = Object.assign({}, lesson);
          }
          //dayOverride.index = mdata[mdataWeekDay].lessons.push(dayOverride) - 1;

        }

        for (var dayOverride of overrides.days) {
          mdata[mdataWeekDay].lessons.push(dayOverride);
        }

      } catch(e) {
        displayError("Någonting gick fel när överskridningen(overrides) skulle laddas, "+ e);
      }

      function calcMinutes() {
        
        if (debugMsg.ikdLineUp) console.log('debugMsg[ikdLineUp]: '+ new Date().getSeconds() + ', '+ new Date().getMilliseconds());

        updatedAt = nowTime();

        var lessons = mdata[0].lessons;
  
        if ((day > 4) || (day < 0)) {

          currentState = state.WEEKEND;
          stateChanged();

          document.getElementById('nextOrCurLes').setSafeText("Helg!");
          //document.getElementById('recalc').style.display = "none";
          return;

        }

        if (mdata[day] != undefined) {

          lessons = mdata[day].lessons;

        } else {

          console.log('There is no lesson data for this day. Showing lessons for Monday.');

        }

        for (var les in lessons) {

          var less = lessons[les];

          if (less.isDisabled) continue;

          if ((less.start <= nowTime()) && (less.end > nowTime())) {

            currentState = state.IN_LESSON;
            stateChanged();

            document.getElementById('nextOrCurLes').setSafeText("Nuvarande lektion");
            document.getElementById('nextLesTime').setSafeText("Slutar om: ").addSafeElement("b", toHourAndMinute(less.end-nowTime()-1,true));
            document.getElementById('nextLesSubject').setSafeText("Ämne: ").addSafeElement("b", less.subject);
            document.getElementById('nextLesClassroom').setSafeText("Sal: ").addSafeElement("b", less.classroom);
            document.getElementById('nextLesStarted').setSafeText("Började: ").addSafeElement("b", toClockTime(less.start));
            document.getElementById('nextLesEnds').setSafeText("Slutar: ").addSafeElement("b", toClockTime(less.end));
            document.getElementById('nextLesLength').setSafeText("Längd: ").addSafeElement("b", toHourAndMinute(getLessonLength(less)));
            document.getElementById('nextLesExtra').setSafeText("");
            
            if (!calcSecondsIntervalId) {

              console.log("Starting calcSeconds interval");
              calcSecondsIntervalId = setInterval(calcSeconds, 1000);
              
            }

            if (shortcutMode) {
              if (shortcutMode == 1) {
                document.getElementById("shortcutSmall1").setSafeText("Denna lektion slutar om");
                document.getElementById("shortcutBig1Minutes").setSafeText(toHourAndMinute(less.end-nowTime()-1,true));
                document.getElementById("shortcutSmall2").setSafeText("Alltså klockan");
                document.getElementById("shortcutBig2").setSafeText(toClockTime(less.end));
              }
            }

            break;

          }

          if (less.start > nowTime()) {

            currentState = state.BREAK;
            stateChanged();

            document.getElementById('nextOrCurLes').setSafeText("Nästa lektion");
            document.getElementById('nextLesTime').setSafeText("Börjar om: ").addSafeElement("b", toHourAndMinute((less.start-nowTime()-1),true));
            document.getElementById('nextLesSubject').setSafeText("Ämne: ").addSafeElement("b", less.subject);
            document.getElementById('nextLesClassroom').setSafeText("Sal: ").addSafeElement("b", less.classroom);
            document.getElementById('nextLesStarted').setSafeText("Börjar: ").addSafeElement("b", toClockTime(less.start));
            document.getElementById('nextLesEnds').setSafeText("Slutar: ").addSafeElement("b", toClockTime(less.end));
            document.getElementById('nextLesLength').setSafeText("Längd: ").addSafeElement("b", toHourAndMinute(getLessonLength(less)));
            document.getElementById('nextLesExtra').setSafeText("");
            
            if (!calcSecondsIntervalId) {

              console.log("Starting calcSeconds interval");
              calcSecondsIntervalId = setInterval(calcSeconds, 1000);
              
            }

            if (shortcutMode) {
              if (shortcutMode == 1) {
                document.getElementById("shortcutSmall1").setSafeText("Nästa lektion börjar om");
                document.getElementById("shortcutBig1Minutes").setSafeText(toHourAndMinute((less.start-nowTime()-1),true));
                document.getElementById("shortcutSmall2").setSafeText("Alltså klockan");
                document.getElementById("shortcutBig2").setSafeText(toClockTime(less.start));
              }
            }

            break;

          }

          if (les >= lessons.length-1) {

            currentState = state.SCHOOL_OVER;
            stateChanged();

            document.getElementById('nextOrCurLes').setSafeText("Skolan är slut!");
            document.getElementById('nextLesTime').setSafeText("");
            document.getElementById('nextLesSubject').setSafeText("");
            document.getElementById('nextLesClassroom').setSafeText("");
            document.getElementById('nextLesStarted').setSafeText("Började: ").addSafeElement("b", toClockTime(mdata[day].lessons[0].start));
            document.getElementById('nextLesLength').setSafeText("Längd: ").addSafeElement("b", toHourAndMinute((mdata[day].lessons[mdata[day].lessons.length-1].end)-(mdata[day].lessons[0].start)));
            document.getElementById('nextLesEnds').setSafeText("Slutade: ").addSafeElement("b",  toClockTime(mdata[day].lessons[mdata[day].lessons.length-1].end));
            document.getElementById('nextLesExtra').setSafeText("Antal lektioner: ").addSafeElement("b", mdata[day].lessons.length);
            document.getElementById('seconds').setSafeText("");
            
            if (calcSecondsIntervalId) {
              
              clearInterval(calcSecondsIntervalId);
              calcSecondsIntervalId = null;
              
            }

            break;

          }
        }
        if (new Date().getTime() > new Date("Jun 13 2019 09:00:00").getTime()) celebreateGo();
      }

      function getLessonLength(lesson) {

        if ((lesson == undefined) || (lesson.start == undefined) || (lesson.end == undefined)) return;

        return lesson.end-lesson.start;

      }

      function getLunch(day) {

        var lessons_before = mdata[day].lunch;

        return {
          start  : mdata[day].lessons[lessons_before-1].end,
          end    : mdata[day].lessons[lessons_before].start,
          length : ((mdata[day].lessons[lessons_before].start)-(mdata[day].lessons[lessons_before-1].end))
        }
       }

      function changeDay(increase) {

        if ((increase == "next") && (lunchDay < 4)) lunchDay++;
        else if ((lunchDay >= 1) && (increase == "prev")) lunchDay--;

        setMats();

        document.getElementById('day').setSafeText(dayNames[lunchDay]);

        if (lunches.length > 9) {

          document.getElementById('lunchFood').setSafeText("Mat: ").addSafeElement("b", lunches[lunchDay*2]);
          document.getElementById('lunchFoodAlt').setSafeText("Alternativ Mat: ").addSafeElement("b", lunches[lunchDay*2+1]);

        }

        var lunch = getLunch(lunchDay);

        document.getElementById('lunchWhen').setSafeText('När: ').addSafeElement("b", toClockTime(lunch.start));
        document.getElementById('lunchEnds').setSafeText('Slutar: ').addSafeElement("b", toClockTime(lunch.end));
        document.getElementById('lunchLength').setSafeText('Längd: ').addSafeElement("b", toHourAndMinute(lunch.length));

      }

      function toTime(hour, min) {

        return hour*60 + min;

      }

      function load() {

        try {
            displayMessages(messages);
        } catch(e) {
            displayError("Något gick fel när meddelanderna skulle visas, "+ e);
        }

        try {

            var params = getParams();

            if (params) {

              if (params.p != undefined) {

                if (params.p == "adam") {

                  Object.assign(params,{
                    s         : "franska",
                    profil    : "Musikprofil",
                    profilSal : "N06... kanske? Jag vet inte... var är det någonstans Adam?"
                  });

                } else {

                  console.log('Invalid value for URL paramater \'s\'!');

                }

              }

              if (params.s != undefined) {

                if (params.s == "franska") {

                  changeLesson(1,0,{subject:"Franska",classroom:"G31",material:undefined});
                  changeLesson(3,2,{subject:"Franska",classroom:"G31",material:undefined});

                  document.getElementById('linkS').value = "Franska";

                } else if (params.s == "tyska") {

                  changeLesson(1,0,{subject:"Tyska",classroom:"G19",material:undefined});
                  changeLesson(3,2,{subject:"Tyska",classroom:"G19",material:undefined});

                  document.getElementById('linkS').value = "Tyska";

                } else if (params.s == "exeng") {

                  changeLesson(1,0,{subject:"Extra Engelska",classroom:"G19b",material:undefined});
                  changeLesson(3,2,{subject:"Extra Engelska",classroom:"G19b",material:undefined});

                  document.getElementById('linkS').value = "Extra Engelska";

                } else {

                  console.log('Invalid value for URL paramater \'s\'!');

                }
              }

              /*if (params.sl != undefined) {

                changeLesson(2,2,{subject:"Syslöjd",classroom:"G47b"});

                  document.getElementById('linkSl').value = "Syslöjd";

              }*/

              if (params.profil != undefined) {

                changeLesson(3,4, {subject:decodeURIComponent(params.profil)})

                if (params.profil == "Programmering") {

                  document.getElementById('linkProfil').value = "Programmering";

                } else {

                  document.getElementById('linkProfil').value = "Annan";
                  linkChange();
                  document.getElementById('linkProfilName').value = decodeURIComponent(params.profil);
                  document.getElementById('linkProfilClassroom').value = decodeURIComponent(params.profilSal);

                }

              }

              if (params.profilSal != undefined) {

                changeLesson(3,4, {classroom:decodeURIComponent(params.profilSal)})

                if (params.profil != "Programmering") {

                  document.getElementById('linkProfilClassroom').value = decodeURIComponent(params.profilSal);

                }

              }

              if (params.mod != undefined) {

                mdata[4].lessons[4] = {subject:decodeURIComponent(params.mod),classroom:"<span style=\"color:red\">error</span>",start: toTime(14,25), end:toTime(15,05)}

                document.getElementById('linkMod').value = "Modersmål";
                linkChange();
                document.getElementById('linkModName').value = decodeURIComponent(params.mod);
                document.getElementById('linkModClassroom').value = decodeURIComponent(params.modSal);

              }

              if (params.modSal != undefined) {

                changeLesson(4,4, {classroom:decodeURIComponent(params.modSal)})

                document.getElementById('linkModClassroom').value = decodeURIComponent(params.ModSal);


              }
          
              if (params.gt != undefined) {
            
                document.getElementById("gt").style.display = "block";
            
              }

            }

        } catch(e) {
            displayError("Något gick fel när url parametrarna skulle laddas, "+ e);
        }

        try {
            makeSchema();
        } catch(e) {
            displayError("Något gick fel när schemat skulle laddas, "+ e);
        }

        changeDay();

        calcSeconds();

        linkChange();
        
        changeGameLink();

        //if (new Date())
        
        /*document.onscroll = function(e){
          var endsTime = document.getElementById('endsTime');
          var b = document.getElementById('recalc').getBoundingClientRect();

          if ((b.y + b.height) < -11) {

            endsTime.style.position = "fixed";
            endsTime.style.top = "0px";
            endsTime.style.padding = "5px";
            endsTime.style.paddingLeft = "0px";
            endsTime.style.backgroundColor = "white";
            endsTime.style.zIndex = 2;

            document.getElementById('recalc').style.marginBottom = "35px";

          } else {

              endsTime.removeAttribute('style');
              document.getElementById('recalc').style.marginBottom = "16px";

          }
        }*/
        
      }

      function toClockTime(val) {

        var hour = Math.floor(val/60).toString();
        var min = (val%60).toString();

        if (min.length == 1) {

          min = "0"+ min;

        }

        return hour +":"+ min;

      }

      function toHourAndMinute(minutes,hasSeconds) {

        if (minutes == 0) return "";

        var hourPlural = "timmar";
        var minPlural = "minuter";
        var and = " och ";

        if ((minutes % 60) == 1) {

          minPlural = "minut";

        }

        if ((Math.floor(minutes/60)) == 1) {

          hourPlural = "timme";

        }
        
        if (hasSeconds) and = ", ";

        if (minutes >= 60) {

          if ((minutes % 60) == 0) {

            return (Math.floor(minutes/60))+" "+ hourPlural;

          } else {

            return (Math.floor(minutes/60))+" "+ hourPlural + and +(minutes%60) +" "+ minPlural;

          }

        } else {

          return minutes +" "+ minPlural;

        }
      }

      function setMats() {

        var matsContainer = document.getElementById('matsContainer');

        matsContainer.setSafeText("");

        for (var les in mdata[lunchDay].lessons) {

          var less = mdata[lunchDay].lessons[les];

          if (less.material == undefined) {

            continue;

          } else {

            var matToAdd = document.createElement('span');

            if (matsContainer.innerHTML == "") {

              matToAdd.addSafeElement("b", less.material);

            } else {

              matToAdd.setSafeText(", ").addSafeElement("b", less.material);

            }

            matsContainer.appendChild(matToAdd);
          }
        }
      }

      function makeSchema() {

        var OFFSET = 440;
        var totalLessons = 0;
        var len = 515;

        function addElement(less, day, index, overridePath) {
          var toAdd = document.createElement('a');

          if (less.border == true) toAdd.style.top = less.start-OFFSET-1 +"px";
          else toAdd.style.top = less.start-OFFSET +"px";

          toAdd.style.width = "100px";
          toAdd.style.height = getLessonLength(less) +"px";
          toAdd.style.left = 102*day + 1 + "px";
          toAdd.title = less.subject;
          toAdd.className = "schema";
          toAdd.href = "javascript:showLessonInfo("+ (!overridePath ? (day +","+ index) : "null,null,"+ JSON.stringify(overridePath)) +")";
          toAdd.addSafeText(less.subject).addSafeElement("br").addSafeText(less.classroom);

          document.getElementById('schemaContainer').appendChild(toAdd);

          var fontSize = parseInt(window.getComputedStyle(toAdd, null).getPropertyValue('font-size'));
          var i = 0;
          while (toAdd.scrollHeight > getLessonLength(less) || toAdd.scrollWidth > 100) {
              fontSize--;
              toAdd.style.fontSize = fontSize;
              i++;
              if (i > 100) {
                console.log("Looped more than 100 times");
                break;
              }
          }

          if (less.end - OFFSET > len) len = less.end - OFFSET;

          return toAdd;
        }

        for (var d in mdata) {

          for (var les in mdata[d].lessons) {

            console.log('Looping through lesson');
            totalLessons++;

            var less = mdata[d].lessons[les];
            if (!less.wasOverridden) addElement(less, d, les);
            else {
              var element = addElement(less.beforeOverrides, d, les);
              element.style.opacity = 0.25;
              if (!less.hideNewOverride) {
                var element = addElement(less, d, les);
                element.style.opacity = 0.6;
              }
            }
          }

        }

        for (var dayOverride of overrides.days) {
          addElement(dayOverride, dayOverride.day, null, ["days", overrides.days.indexOf(dayOverride)]);
        }

        for (var i = 0; i < mdata.length+1; i++) {

          var toAdd = document.createElement('div');

          toAdd.className = "schemaDay";
          if (i != mdata.length) toAdd.style.left = 102*i-1 + "px";
          else toAdd.style.left = 102*i-3 + "px";

          if (len != 515) {

              toAdd.style.height = len + "px";
              document.getElementById('schemaBottom').style.top = len + "px";
              document.getElementById('schemaContainer').style.height = len + 20 + "px";

          }

          document.getElementById('schemaContainer').appendChild(toAdd);

        }


        document.getElementById('showing').setSafeText("Visar "+ totalLessons +"/"+ totalLessons);

      }

      function schemaSearch() {

        var schemaDiv = document.getElementById('schemaContainer');

        var filter = document.getElementById('searchSchema').value.toLowerCase();

        var schemas = schemaDiv.getElementsByClassName('schema');

        var showing = schemas.length;

        for (var schem in schemas) {

          var schema = schemas[schem];

          if (typeof schema != "object") {

            continue;

          }

          if (!(schema.innerText.toLowerCase().includes(filter))) {

            schema.style.display = "none";
            showing--;

          } else {

            schema.style.display = "";

          }
        }

        var showingP = document.getElementById('showing');

        showingP.setSafeText("Visar "+ showing +"/"+ schemas.length);
      }

      function showLessonInfo(day, les, overridePath) {

        var less = !overridePath ? mdata[day].lessons[les] : overrides[overridePath[0]][overridePath[1]];

        document.getElementById('lessonInfo').style.display = "block";

        document.getElementById('lessonInfoSubject').setSafeText("Ämne: ").addSafeElement("b", less.subject);
        document.getElementById('lessonInfoClassroom').setSafeText("Sal: ").addSafeElement("b", less.classroom);
        document.getElementById('lessonInfoLength').setSafeText("Längd: ").addSafeElement("b", toHourAndMinute(getLessonLength(less)));
        document.getElementById('lessonInfoStarts').setSafeText("Börjar: ").addSafeElement("b", toClockTime(less.start));
        document.getElementById('lessonInfoEnds').setSafeText("Slutar: ").addSafeElement("b", toClockTime(less.end));
        document.getElementById('lessonInfoDay').setSafeText("Dag: ").addSafeElement("b", dayNames[day]);

        if (less.material == undefined) {

          document.getElementById('lessonInfoMaterial').style.display = "none";

        } else {

          document.getElementById('lessonInfoMaterial').setSafeText("Material: ").addSafeElement("b", less.material);
          document.getElementById('lessonInfoMaterial').style.display = "block";

        }


        if (less.note == undefined) {

          document.getElementById('lessonInfoNote').style.display = "none";

        } else {

          document.getElementById('lessonInfoNote').setSafeText("Info: ").addSafeElement("b", less.note);
          document.getElementById('lessonInfoNote').style.display = "block";

        }


        if (window.innerWidth < 400) {

          document.getElementById('lessonInfo').style.width = "90%";
          document.getElementById('lessonInfo').style.left = null;
          document.getElementById('lessonInfo').style.marginLeft = null;

        } else {

          document.getElementById('lessonInfo').style.width = "300px";
          document.getElementById('lessonInfo').style.left = "50%";
          document.getElementById('lessonInfo').style.marginLeft = "-150px";
        }

      }

      function newDay() {

        if(day != new Date().getDay()-1) {

          day = new Date().getDay()-1;

        }

      }

      function getParams() {

        var p = document.URL.split('?');
        //var p = "https://alvinn8.github.io/s/?profil=Programmering&profilSal=%3Cimg%20src%3D%22x%22%20onerror%3D%22console.log('vuln')%22%3E".split('?'); /* fake url paramaters (for local file testing)*/

        var pa;

        if (p[1] == undefined) {

          return;

        } else {

          pa = p[1].split('&');

        }

        var returnObject = {};

        for (var i = 0; i < pa.length; i++) {

          var par = pa[i];

          returnObject[par.split('=')[0]] = par.split('=')[1];

        }

        return returnObject;

      }

      function changeLesson(day,lesson, newLesson) {

        mdata[day].lessons[lesson] = Object.assign(mdata[day].lessons[lesson],newLesson);

      }

      function displayMessage(msg, backcolor, bordercolor) {

        var container = document.getElementById('messagesTop');

        var toAdd = document.createElement('div');

        toAdd.addSafeElement("p", msg);
        toAdd.className = "message";
        if (backcolor) toAdd.style.backgroundColor = backcolor;
        if (bordercolor) toAdd.style.border = "2px solid "+ bordercolor;

        container.appendChild(toAdd);

      }

      /*function displayError(msg) {
          displayMessage(msg, "pink", "red");
      }*/

      function displayMessages(v) {

        for (var i = 0; i < v.constant.length; i++) {

          var info = v.constant[i];

          displayMessage(info.message, info.backcolor, info.bordercolor);

        }

        for (var i = 0; i < v.date.length; i++) {

          var info = v.date[i];

          if ((new Date().getMonth() + 1 == info.date[0]) && (new Date().getDate() == info.date[1])) {

            displayMessage(info.message, info.backcolor, info.bordercolor);

          }

        }

      }

      function getLunchFood() {

        document.getElementById('lunchFood').style.display = null;
        document.getElementById('lunchFoodAlt').style.display = null;
        document.getElementById('getLunch').style.display = "none";

        alert('error');
      }

      function linkChange() {

        var link = "https://alvinn8.github.io/s/";

        var firstParamUsed = false;

        if (document.getElementById('linkS').value != "Spanska") {

          if (document.getElementById('linkS').value != "Extra Engelska") {

            link += "?s="+ document.getElementById('linkS').value.toLowerCase();
            firstParamUsed = true;

          } else {

            link += "?s=exeng";
            firstParamUsed = true;

          }

        }

        if (document.getElementById('linkSl').value != "Träslöjd") {

          if (firstParamUsed) {

            link += "&sl=t";

          } else {

            link +="?sl=t";
            firstParamUsed = true;

          }

        }

        if (document.getElementById('linkProfil').value == "Annan") {

          document.getElementById('linkProfilName').style.display = null;
          document.getElementById('linkProfilClassroom').style.display = null;

          if (firstParamUsed) {

            link += "&profil="+ document.getElementById('linkProfilName').value +"&profilSal="+ document.getElementById('linkProfilClassroom').value;

          } else {

            link +="?profil="+ document.getElementById('linkProfilName').value +"&profilSal="+ document.getElementById('linkProfilClassroom').value;
            firstParamUsed = true;

          }

        } else {

          document.getElementById('linkProfilName').style.display = "none";
          document.getElementById('linkProfilClassroom').style.display = "none";

          if (document.getElementById('linkProfil').value == "Programmering") {

            if (firstParamUsed) {

              link += "&profil=Programmering&profilSal=T19";

            } else {

              link += "?profil=Programmering&profilSal=T19";

            }

          }

        }

        if (document.getElementById('linkMod').value == "Modersmål") {

          document.getElementById('linkModName').style.display =  null;
          document.getElementById('linkModClassroom').style.display =  null;

          if (firstParamUsed) {

            link += "&mod="+ document.getElementById('linkModName').value +"&modSal="+ document.getElementById('linkModClassroom').value;

          } else {

            link += "?mod="+ document.getElementById('linkModName').value +"&modSal="+ document.getElementById('linkModClassroom').value;
            firstParamUsed = true;

          }

        } else {

          document.getElementById('linkModName').style.display =  "none";
          document.getElementById('linkModClassroom').style.display =  "none";

        }

        document.getElementById('linkResult').value = link;
        history.replaceState(null, null, link.substr("https://alvinn8.github.io/s/".length));

      }
      
      function calcSeconds() {

        var seconds = document.getElementById('seconds');
        var time = 60 - new Date().getSeconds();
        var and = " och ";

        if ((day > 4) || (day < 0)) return;
        
        if (time == 60 || updatedAt != nowTime()) {

          newDay();
          calcMinutes();

        }

        if (currentState == state.SCHOOL_OVER || currentState == state.WEEKEND) return;

        if (!(document.getElementById('nextLesTime').children.length && document.getElementById('nextLesTime').children[0].innerHTML)) and = "";

        var text = and + time + " sekund" + (time == 1 ? "" : "er");

        seconds.setSafeText(text);
        if (shortcutMode) {
            var shortcutBig1 = document.getElementById("shortcutBig1");
            if (shortcutMode == 1) {
                var seconds = document.getElementById("shortcutBig1Seconds");
                seconds.setSafeText(text);
            }
        }

      }
      
      function changeGameLink() {

        var linkIndex = parseInt(Math.random()*boredLinks.length);

        document.getElementById('killTime').href = boredLinks[linkIndex];

        boredLinks.splice(linkIndex, 1);

        if (boredLinks.length < 1) boredLinks = allBoredLinks.slice(0);

      }

      function stateChanged() {

          if (currentState == state.IN_LESSON) {

              document.getElementById("killTimeContainer").style.opacity = 0.5;
              document.getElementById("killTimeContainer").style.pointerEvents = "none";
              document.getElementById("killTimeTitle").style.textDecoration = "line-through";
              document.getElementById("killTimeText").style.textDecoration = "line-through";
              document.getElementById("killTimeDisabled").style.display = "block";

          } else {

              document.getElementById("killTimeContainer").style.opacity = 1;
              document.getElementById("killTimeContainer").style.pointerEvents = "all";
              document.getElementById("killTimeTitle").style.textDecoration = "none";
              document.getElementById("killTimeText").style.textDecoration = "none";
              document.getElementById("killTimeDisabled").style.display = "none";


          }

      }

      function getWeek() {
          var date = new Date();
          var date2 = new Date();
          for (var i = 0; i < 53; i++) {
              date2 = new Date(date2.getTime() - 1000 * 60 * 60 * 24 * 7); // Subtract a week
              if (date.getYear() != date2.getYear()) {
                  return i + 1; // Computers count from 0
               }
          }
      }

    </script>
  </head>

  <body onload="load();">

  <div id="messagesTop"></div>

  <h2 id="nextOrCurLes">Nästa lektion</h2>

  <button id="recalc" onclick="newDay();calcMinutes();" style="margin-bottom: 11px;">Räkna om</button>

  <br>
  <div id="endsTime" style="position: -webkit-sticky; position: sticky; top: 0px; background-color: white; z-index: 2; padding: 5px; padding-left: 0px;">
    <span id="nextLesTime"></span>
    <b id="seconds"></b>
  </div>
  <p id="nextLesSubject" style="margin-top: 11px;"></p>
  <p id="nextLesClassroom"></p>
  <p id="nextLesStarted"></p>
  <p id="nextLesEnds"></p>
  <p id="nextLesLength"></p>
  <p id="nextLesExtra"></p>

  <hr>

  <h2 id="day">Loading</h2>

  <button onclick="changeDay('prev')">Föregående dag</button>

  <button onclick="changeDay('next')">Nästa dag</button>

  <h3>Info om dagen:</h3>

  <span>Material: </span>
  <div id="matsContainer" style="
    display: inline;
  "></div>

  <h3 style="
    margin-bottom:0px
  ">Lunch</h3>

  <button id="getLunch" onclick="getLunchFood()" style="margin-top:10px;display:none;">Hämta matsedel</button>

  <p id="lunchFood" style="display:none;">Mat: <i>Hämtar matsedel</i></p>
  <p id="lunchFoodAlt" style="display:none;">Alternativ Mat: <i>Hämtar matsedel</i></p>

  <p id="lunchWhen"></p>
  <p id="lunchEnds"></p>
  <p id="lunchLength"></p>

  <hr>

  <h2>Schema</h2>

  <input placeholder="Sök" id="searchSchema" onkeyup="schemaSearch()" style="
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #ddd;
    /*background-image: url('search-icon.png');*/
    /*background-position: 4px 4px;*/
    /*background-repeat: no-repeat;*/
    /*background-size: 16px;*/
    /*padding-left: 22px;*/
  ">
  <p id="showing" style="
    margin-bottom: 20px;
  "></p>

  <div id="schemaContainer" style="
    position: relative;
    width: 100%;
    height: 535px;
    overflow: auto;
  ">

    <style>
      .schema {
        position: absolute;
        background-color: lime;
        border-top: 1px solid green;
        border-bottom: 1px solid green;
        text-decoration: none;
        color: black;
        text-align: center;
        margin: 0px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: small;
        box-sizing: border-box;
      }

      .schemaDay {
        position: absolute;
        background-color: black;
        height: 515px;
        width: 2px;
        z-index: 1;
      }

      .schemaDayTop {
        position: absolute;
        background-color: black;
        height: 2px;
        width: 507px;
      }

    </style>
    <p style="position: absolute;left: 20px;top: -5px;">Måndag</p>
    <p style="position: absolute;left: 130px;top: -5px;">Tisdag</p>
    <p style="position: absolute;left: 230px;top: -5px;">Onsdag</p>
    <p style="position: absolute;left: 330px;top: -5px;">Torsdag</p>
    <p style="position: absolute;left: 435px;top: -5px;">Fredag</p>

    <!--<div class="schemaDay" style="left: 407px;"></div>
    <div class="schemaDay" style="left: 507px;"></div>-->
    <div class="schemaDayTop"></div>
    <div class="schemaDayTop" style="top: 38px;"></div>
    <div class="schemaDayTop" style="top: 515px; left: -1px; width: 510px;" id="schemaBottom"></div>

  </div>

  <div id="lessonInfo" style="
    display: block;
    border: 2px solid green;
    width: 300px;
    padding-left: 10px;
    background-color: lime;
    border-radius: 10px;
    z-index: 1;
    box-shadow: black 1px 1px 10px;
    position: fixed;
    top: 33%;
    left: 50%;
    margin-left: -150px;
    display: none;
  ">
      <button onclick="document.getElementById('lessonInfo').style.display = 'none';" style="
        background-color: transparent;
        border: none;
        cursor: pointer;
        float: right;
        margin: 5px;
        margin-top: 0px;
        font-size: xx-large;
      ">&times;</button>
      <p id="lessonInfoSubject">Error</p>
      <p id="lessonInfoClassroom"></p>
      <p id="lessonInfoStarts"></p>
      <p id="lessonInfoEnds"></p>
      <p id="lessonInfoLength"></p>
      <p id="lessonInfoDay"></p>
      <p id="lessonInfoMaterial"></p>
      <p id="lessonInfoNote"></p>
  </div>

  <h2>Länk</h2>

  <p>Generera en länk som stämmer för dig</p>

  <select onchange="linkChange()" id="linkS">
    <option>Spanska</option>
    <option>Franska</option>
    <option>Tyska</option>
    <option>Extra Engelska</option>
  </select>
  <select onchange="linkChange()" id="linkSl" disabled="disabled">
    <option>Träslöjd</option>
    <option>Syslöjd</option>
  </select>
  <select onchange="linkChange()" id="linkProfil">
    <option>Profil</option>
    <option c="T20">Programmering</option>
    <option>Annan</option>
  </select>
  <select onchange="linkChange()" id="linkMod">
    <option>Inget Modersmål</option>
    <option>Modersmål</option>
  </select>

  <input placeholder="Profilnamn" onchange="linkChange()" id="linkProfilName" style="display:none;">
  <input placeholder="Sal" onchange="linkChange()" id="linkProfilClassroom" style="display:none;">

  <input placeholder="Modersmål" onchange="linkChange()" id="linkModName" style="display:none;">
  <input placeholder="Sal" onchange="linkChange()" id="linkModClassroom" style="display:none;">

  <br>

  <input onclick="this.select();this.setSelectionRange(0, 9999);" id="linkResult" value="https://alvinn8.github.com/s/" readonly style="
    width: 250px;
  ">

    <div id="killTimeContainer">
    
        <h2 id="killTimeTitle">Har du tråkigt?</h2>
        <p id="killTimeText">Klicka <a href="#" target="_blank" id="killTime" onclick="changeGameLink()">här</a> om du vill fördriva tiden medans du väntar</p>
        <p id="killTimeDisabled" style="display: none;">Inte spela på lektionstid!</p>

    </div>

    <div style="margin-bottom: 100px;">
        <h2>Kortkommandon</h2>
        <table>
            <tr>
                <th>Tangent</th>
                <th>Beskrivning</th>
            </tr>
            <tr>
                <td>a</td>
                <td>När slutar den här lektionen? / När börjar nästa lektion?</td>
            </tr>
            <tr>
                <td>b</td>
                <td>När slutar vi idag?</td>
            </tr>
        </table>
        <style>
        table, th, td {
          border: 1px solid black;
          border-collapse: collapse;
        }
        th {
            text-align: left;
        }
        td, th {
            padding: 5px;
        }
        </style>
    </div>

    <div id="gt" style="
    width: 500px;
    height: 500px;
    position: fixed;
    right: 100px;
    top: 0px;
    display: none;
    z-index: 2;
    pointer-events: none;
"><svg xmlns="http://www.w3.org/2000/svg" width="580" height="400">
 <!-- Created with Method Draw - http://github.com/duopixel/Method-Draw/ -->
 <g>
  <title>background</title>
  <!--<rect id="canvas_background" height="402" width="582" y="-1" x="-1" fill="#fff"></rect>-->
  <g display="none" overflow="visible" y="0" x="0" height="100%" width="100%" id="canvasGrid">
   <rect fill="url(#gridpattern)" stroke-width="0" y="0" x="0" height="100%" width="100%"></rect>
  </g>
 </g>
 <g>
  <title>Layer 1</title>
  <line stroke-linecap="undefined" stroke-linejoin="undefined" id="svg_1" y2="332.187499" x2="462.499998" y1="71.187499" x1="459.499998" stroke-width="1.5" stroke="#000" fill="none"></line>
  <line stroke-linecap="undefined" stroke-linejoin="undefined" id="svg_2" y2="59.187499" x2="348.499998" y1="122.187499" x1="432.499998" stroke-width="1.5" stroke="#000" fill="none"></line>
  <line stroke-linecap="undefined" stroke-linejoin="undefined" id="svg_3" y2="150.187499" x2="332.499998" y1="209.187499" x1="428.499998" stroke-width="1.5" stroke="#000" fill="none"></line>
  <line stroke-linecap="undefined" stroke-linejoin="undefined" id="svg_4" y2="234.187499" x2="326.499998" y1="287.187499" x1="426.499998" stroke-width="1.5" stroke="#000" fill="none"></line>
 </g>
</svg></div>

    <div id="shortcut" style="
    border: 2px solid green;
    width: 500px;
    padding-left: 10px;
    background-color: lime;
    border-radius: 10px;
    z-index: 3;
    box-shadow: black 1px 1px 10px;
    position: fixed;
    top: 33%;
    left: 50%;
    margin-left: -250px;
    display: none;
    text-align: center;">
        <button onclick="document.getElementById('shortcut').style.display = 'none';shortcutMode = 0;" style="
        background-color: transparent;
        border: none;
        cursor: pointer;
        float: right;
        margin-top: 0px;
        font-size: xx-large;
        position: absolute;
        right: 5px;
        ">×</button>
        <p id="shortcutSmall1"></p>
        <b id="shortcutBig1" style="font-size: 26px;"></b>
        <p id="shortcutSmall2"></p>
        <b id="shortcutBig2" style="font-size: 26px;"></b>
    </div>
    
</body>
</html>
